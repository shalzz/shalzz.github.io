<!doctype html><html lang=en><head><meta charset=utf-8><meta content="IE=edge,chrome=1" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1" name=viewport><meta content="interest-cohort=()" http-equiv=Permissions-Policy><title>
  Forwarding Calls and Texts Internationally with a VoIP Server and Modem
</title><meta content="Special thanks to Pramey Singh for feedback and review.



As a Sovereign Individual, traveling and staying overseas for long periods frequently, switching sim cards/numbers can quickly become a pain.
It can be helpful to still retain control over an operational phone number of your home country across geolocations.
Doing so lets you forward and make local home calls and be able to receive your bank’s account and OTP related text messages.
The solution proposed here isn’t a location dependent one like using Google Fi or relying on expensive international roaming plans.
Instead, it gives you ownership and freedom to retain, switch or dispose of your phone numbers at local rates, across political borders." name=description><meta content="Asterisk, Asterisk server, sip server, Twilio, openwrt, sms, sip, voip, sip phone, sms to email, email, gsmbox, gsm, modem, rtp, srtp, sms hijacking, sim swap, sim swap attack, mitigate sim swap, gsm box, huawei dongle, Asterisk-chan-dongle, Asterisk-chan-quectel, BYOC trunk, pstn, forwarding" name=keywords><meta content="Shaleen Jain" name=author><link href=https://twitter.com/shalzzj rel=author><link href=https://shaleenjain.com/blog/asterisk-sip-server/ rel=canonical><link href=https://shaleenjain.com/atom.xml rel=alternate title=RSS type=application/atom+xml><meta content=@shalzzj name=twitter:site><meta content=@shalzzj name=twitter:creator><meta content=article property=og:type><meta content=https://shaleenjain.com/blog/asterisk-sip-server/ property=og:url><meta content="Special thanks to Pramey Singh for feedback and review.



As a Sovereign Individual, traveling and staying overseas for long periods frequently, switching sim cards/numbers can quickly become a pain.
It can be helpful to still retain control over an operational phone number of your home country across geolocations.
Doing so lets you forward and make local home calls and be able to receive your bank’s account and OTP related text messages.
The solution proposed here isn’t a location dependent one like using Google Fi or relying on expensive international roaming plans.
Instead, it gives you ownership and freedom to retain, switch or dispose of your phone numbers at local rates, across political borders." property=og:description><meta content="Forwarding Calls and Texts Internationally with a VoIP Server and Modem" name=twitter:title><meta content="Forwarding Calls and Texts Internationally with a VoIP Server and Modem" property=og:title><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/manifest.json rel=manifest><link href=/icons/safari-pinned-tab.svg rel=mask-icon><link rel="shortcut icon" href=/icons/favicon.ico><meta content=/icons/browserconfig.xml name=msapplication-config><meta content=#ffffff name=theme-color><style>/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */
html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{margin:.67em 0;font-size:2em}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace;font-size:1em}a{background-color:#0000}abbr[title]{border-bottom:none;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace;font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:100%;line-height:1.15}button,input{overflow:visible}button,select{text-transform:none}button,[type=button],[type=reset],[type=submit]{-webkit-appearance:button}button::-moz-focus-inner,[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}button:-moz-focusring,[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted buttontext}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;white-space:normal;max-width:100%;padding:0;display:table}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template,[hidden]{display:none}html{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}*,:before,:after{box-sizing:inherit}.image-row{flex-flow:wrap;align-items:center;padding:0 4px;display:flex}.image-column{border-radius:8px;flex:50%;width:100%;max-width:50%;height:auto;padding:0 4px}@media screen and (width<=42em){.image-column{flex:100%;max-width:100%}}.text-center{text-align:center}.text-right{text-align:right}.fa-social-icons{margin-top:-1rem;font-size:2rem}.fa-social-icons a{border:0;margin-right:.1rem}.fa-social-icons a:last-child{margin-right:0}.masthead,.content,.footer{max-width:42em;margin-left:auto;margin-right:auto}.masthead:after,.post:after,.related:after,.recent:after,.page:after,.comments:after,.index:after{content:"";background-color:#c4c4c4;width:150px;height:1px;margin:2rem auto;display:block}.related .related-title,.related .recent-title,.recent .related-title,.recent .recent-title{margin-top:0}.masthead{text-align:right;margin-bottom:2rem;padding-top:1rem}.masthead a{color:#111}.masthead .masthead-title{float:left;margin:0;padding:0}.masthead .masthead-title a{border:0;text-decoration:none}.masthead .masthead-nav{margin-bottom:0;padding-left:0;display:inline-block}.masthead .masthead-nav a{border:0;text-decoration:none}.masthead .masthead-nav a+a{margin-left:.6rem}.footer{text-align:center;margin-bottom:1rem}.footer a[rel=license]:first-child{border:0;margin:0;padding:0;text-decoration:none;display:inline-block}.footer .icon-square{color:#0000}.footer .icon-square:hover{color:#252525}.footer .fa-stack-1x{color:#000}.footer p>span{font-size:110%}.footer p>span a{border:0;padding:2px}.footer p>span i:hover{color:#fff}.footer p p:last-child{margin-bottom:0}.posts{padding-bottom:1rem}.posts .posts-item{margin-bottom:1rem}@media (width>=42em){.posts .posts-item{margin-bottom:.2rem}}.posts a{border:0}.posts time{color:#848484;display:block}@media (width>=42em){.posts time{float:right;margin-top:2px}}.next,.previous{font-size:20px;font-weight:600;transition:transform .3s ease-out}.next{float:right}.next:hover{transform:translate(4px)}.previous{float:left}.previous:hover{transform:translate(-4px)}html,body{margin:0}html{font-family:Lora,"sans-serif";font-size:20px;line-height:1.6}@media (width>=42em){html{font-size:22px}}body{color:#444;-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;background-color:#fff;padding:2rem 1.5rem}a{color:#4d8b00;border-bottom:1px solid #4d8b00;text-decoration:none}a:hover,a:focus{color:#fff;background-color:#4d8b00}a strong{color:inherit}img{border-radius:5px;max-width:100%;margin:0 0 1rem;display:block}table{border-collapse:collapse;border:1px solid #c4c4c4;width:100%;margin-bottom:1rem;font-size:85%}.js-file-line-container td{border:none}td,th{border:1px solid #c4c4c4;padding:.25rem .5rem}th{text-align:left}tbody tr:nth-child(2n) td,tbody tr:nth-child(2n) th{background-color:#fff}tbody tr:nth-child(odd) td,tbody tr:nth-child(odd) th{background-color:#fafafa}</style><style>@font-face{font-family:Lora;font-style:italic;font-weight:400;font-display:swap;src:url(/fonts/0QI8MX1D_JOuMw_hLdO6T2wV9KnW-MoFoq92nA.woff2)format("woff2");unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:Lora;font-style:normal;font-weight:400;font-display:swap;src:url(/fonts/0QI6MX1D_JOuGQbT0gvTJPa787weuxJBkq0.woff2)format("woff2");unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:Lora;font-style:normal;font-weight:700;font-display:swap;src:url(/fonts/0QI6MX1D_JOuGQbT0gvTJPa787z5vBJBkq0.woff2)format("woff2");unicode-range:U+??,U+131,U+152-153,U+2BB-2BC,U+2C6,U+2DA,U+2DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style><body><link href=/style.css rel=stylesheet><style>#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
	/* MailChimp Form Embed Code - Classic - 12/17/2015 v10.7 */
	#mc_embed_signup form {display:block; position:relative; text-align:left;}
	#mc_embed_signup h2 {font-weight:bold; padding:0; margin:15px 0; font-size:1.4em;}
	#mc_embed_signup input {border: 1px solid #ABB0B2; -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px;}
	#mc_embed_signup input[type=checkbox]{-webkit-appearance:checkbox;}
	#mc_embed_signup input[type=radio]{-webkit-appearance:radio;}
	#mc_embed_signup input:focus {border-color:#333;}
	#mc_embed_signup .button {clear:both; background-color: #aaa; border: 0 none; border-radius:4px; transition: all 0.23s ease-in-out 0s; color: #FFFFFF; cursor: pointer; display: inline-block; font-size:15px; font-weight: normal; height: 32px; line-height: 32px; margin: 0 5px 10px 0; padding: 0 22px; text-align: center; text-decoration: none; vertical-align: top; white-space: nowrap; width: auto;}
	#mc_embed_signup .button:hover {background-color:#777;}
	#mc_embed_signup .small-meta {font-size: 11px;}
	#mc_embed_signup .nowrap {white-space:nowrap;}

	#mc_embed_signup .mc-field-group {clear:left; position:relative; width:96%; padding: 0.5%; min-height:50px;}
	#mc_embed_signup .size1of2 {clear:none; float:left; display:inline-block; width:46%; margin-right:4%;}
	* html #mc_embed_signup .size1of2 {margin-right:2%; /* Fix for IE6 double margins. */}
	#mc_embed_signup .mc-field-group label {display:block; margin-bottom:3px;}
	#mc_embed_signup .mc-field-group input {display:inline; width:100%; padding:8px 0; text-indent:2%;}
	#mc_embed_signup .mc-field-group select {display:inline-block; width:99%; padding:5px 0; margin-bottom:2px;}

	#mc_embed_signup .datefield, #mc_embed_signup .phonefield-us{padding:5px 0;}
	#mc_embed_signup .datefield input, #mc_embed_signup .phonefield-us input{display:inline; width:60px; margin:0 2px; letter-spacing:1px; text-align:center; padding:5px 0 2px 0;}
	#mc_embed_signup .phonefield-us .phonearea input, #mc_embed_signup .phonefield-us .phonedetail1 input{width:40px;}
	#mc_embed_signup .datefield .monthfield input, #mc_embed_signup .datefield .dayfield input{width:30px;}
	#mc_embed_signup .datefield label, #mc_embed_signup .phonefield-us label{display:none;}

	#mc_embed_signup .asterisk {color:#e85c41; font-size:150%; font-weight:normal; position:relative; top:5px;}     
	#mc_embed_signup .mce-submit {padding: 0.5%;}
	#mc_embed_signup_scroll {display: flex; justify-items; space-around;}

	#mc_embed_signup .mc-field-group.input-group ul {margin:0; padding:5px 0; list-style:none;}
	#mc_embed_signup .mc-field-group.input-group ul li {display:block; padding:3px 0; margin:0;}
	#mc_embed_signup .mc-field-group.input-group label {display:inline;}
	#mc_embed_signup .mc-field-group.input-group input {display:inline; width:auto; border:none;}

	#mc_embed_signup div#mce-responses {clear: both;}
	#mc_embed_signup div.response {margin:1em 0; padding:1em .5em .5em 0; font-weight:bold; float:left; top:-1.5em; z-index:1; width:80%;}
	#mc_embed_signup #mce-error-response {display:none;}
	#mc_embed_signup #mce-success-response {color:#529214; display:none;}
	#mc_embed_signup label.error {display:block; float:none; width:auto; margin-left:1.05em; text-align:left; padding:.5em 0;}

	#mc-embedded-subscribe {clear:both; width:auto; display:block; margin:1em 0 1em 5%;}
	#mc_embed_signup #num-subscribers {font-size:1.1em;}
	#mc_embed_signup #num-subscribers span {padding:.5em; border:1px solid #ccc; margin-right:.5em; font-weight:bold;}

	#mc_embed_signup #mc-embedded-subscribe-form div.mce_inline_error {display:inline-block; margin:2px 0 1em 0; padding:5px 10px; background-color:rgba(255,255,255,0.85); -webkit-border-radius: 3px; -moz-border-radius: 3px; border-radius: 3px; font-size:14px; font-weight:normal; z-index:1; color:#e85c41;}
	#mc_embed_signup #mc-embedded-subscribe-form input.mce_inline_error {border:2px solid #e85c41;}
	/* Add your own Mailchimp form style overrides in your site stylesheet or in this style block.
	   We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */</style><header class=masthead><h3 class=masthead-title><a href=/>Shaleen Jain</a></h3><nav class=masthead-nav><a class=nav-item href=/blog>Blog</a></nav></header><main class=content><article class=post><header class=post-header><time class=post-date datetime=2022-06-04> 04 Jun 2022 </time><small> · <span title="Estimated read time" class=reading-time> 9 min read </span> </small><h1 class=post-title>Forwarding Calls and Texts Internationally with a VoIP Server and Modem</h1></header><p><em>Special thanks to Pramey Singh for feedback and review.</em><p>As a <a rel="noopener nofollow noreferrer" href=https://dougantin.com/the-sovereign-individual-what-you-need-to-know-why/ target=_blank>Sovereign Individual</a>, traveling and staying overseas for long periods frequently, switching sim cards/numbers can quickly become a pain. It can be helpful to still retain control over an operational phone number of your home country across geolocations. Doing so lets you forward and make local home calls and be able to receive your bank’s account and OTP related text messages.<p>The solution proposed here isn’t a location dependent one like using <a rel="noopener nofollow noreferrer" href=https://fi.google.com/about/ target=_blank>Google Fi</a> or relying on expensive international roaming plans. Instead, it gives you ownership and freedom to retain, switch or dispose of your phone numbers at local rates, across political borders.</p><span id=continue-reading></span><p>In the same vein, I recently tweeted about taking control of your messaging platforms to have custody over your chat messages. Helping you maintain a new layer of privacy via isolation as well as improving your quality of life by unifying your chatting platforms. This article though focuses only on voice and text communication.</p><script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script><div style=justify-content:center;display:flex><blockquote class=twitter-tweet><a href=https://twitter.com/shalzzj/status/1499689706367643649></a></blockquote></div><br><details id=toc-inline open><summary><b>Table of Contents</b></summary> <ul><li><a href=#overview>Overview</a><li><a href=#benefits>Benefits</a><li><a href=#asterisk-pbx-server>Asterisk PBX Server</a> <ul><li><a href=#asterisk-chan-dongle>Asterisk-chan-dongle</a><li><a href=#sms-forwarding-optional>SMS Forwarding (Optional)</a><li><a href=#configuration>Configuration</a><li><a href=#nat-settings-optional>NAT settings (optional)</a></ul><li><a href=#twilio>Twilio</a><li><a href=#softphone>Softphone</a><li><a href=#further-improvements>Further Improvements</a></ul></details><h2 id=overview><a aria-label="Anchor link for: overview" class=zola-anchor href=#overview>🔗</a> Overview</h2><p>The solution to the above problem is to move onto a <a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Session_Initiation_Protocol target=_blank>SIP</a>/<a rel="noopener nofollow noreferrer" href=https://en.wikipedia.org/wiki/Real-time_Transport_Protocol target=_blank>RTP</a> stack for all our voice calls by switching to a VOIP service provider and possibly relying on our PBX server (depending on the jurisdiction’s regulation).<p>When we have our complete VOIP stack in place we’ll have a pipeline like this:<pre style=color:#657b83;background-color:#fdf6e3><code><span>PSTN Carrier &lt;-> 3G/4G Dongle &lt;-> Asterisk Server &lt;-> Twilio (VOIP Provider) &lt;-> VOIP Softphone
</span></code></pre><h2 id=benefits><a aria-label="Anchor link for: benefits" class=zola-anchor href=#benefits>🔗</a> Benefits</h2><p>With this approach, we can redirect traditional PSTN calls over VOIP to us anywhere across the globe. Plus since there’s no longer a SIM card required to be tethered to a single device, we can make and receive calls across multiple devices.<p>This also mitigates the ever-growing threat of SIM swap attacks. Both, physical attacks as the SIM card associated with your number is no longer required to be always in your phone, and operator social engineering attacks since most VOIP providers have a higher security level than most traditional telecom providers.<h2 id=asterisk-pbx-server><a aria-label="Anchor link for: asterisk-pbx-server" class=zola-anchor href=#asterisk-pbx-server>🔗</a> Asterisk PBX Server</h2><p>While the regulation of some countries like the US allows buying a consumer feature level number from a VOIP provider like <a rel="noopener nofollow noreferrer" href=https://www.twilio.com/ target=_blank>Twilio</a> with unrestricted functionality for calls and SMS/MMS. The feature set starts to degrade drastically from what we are used to when buying local numbers for most other countries.<p>If you are following this guide with a US number or any other country that allows first-class support to VOIP providers then you can skip this section on setting up an Asterisk server.<p>If however you find yourself with a number from a country that restricts VOIP providers from providing full feature-set local numbers then we can circumvent that via a 3G/4G USB dongle with voice calling support. This allows us to then bring up a PBX server connected to the internet with the ability to route traditional PBX calls via the USB dongle holding your own local number SIM card.<p>The first step is to then install an <a rel="noopener nofollow noreferrer" href=https://www.asterisk.org/ target=_blank>Asterisk</a> server on a machine that can be left running 24/7 for maximum uptime. This guide uses OpenWRT OS and packages in examples but you can use any machine you have lying around including a Raspberry Pi.<p>With an already set up OpenWRT router, you’ll need the following packages to install Asterisk:<pre class=language-sh data-lang=sh style=color:#657b83;background-color:#fdf6e3><code class=language-sh data-lang=sh><span style=color:#b58900>opkg</span><span> install Asterisk Asterisk-pjsip Asterisk-bridge-simple Asterisk-codec-alaw Asterisk-codec-ulaw Asterisk-res-rtp-Asterisk Asterisk-res-srtp Asterisk-chan-dongle
</span></code></pre><h3 id=asterisk-chan-dongle><a aria-label="Anchor link for: asterisk-chan-dongle" class=zola-anchor href=#asterisk-chan-dongle>🔗</a> Asterisk-chan-dongle</h3><p>Now comes the tough part of acquiring and setting up a USB dongle. We’re using <a rel="noopener nofollow noreferrer" href=https://github.com/wdoekes/asterisk-chan-dongle target=_blank>wdoekes/Asterisk-chan-dongle</a> an Asterisk channel driver for interfacing with the USB dongle from the Asterisk server.<p>The tricky part here is that the channel driver doesn’t work with every 3G/4G USB dongle, only Huawei 3G dongles and a few 4G dongles. And even with the dongles that it does work, not every supported dongle has voice support available or firmware unlocked.<p>The best way is to look at the list of supported dongles on the project’s <a rel="noopener nofollow noreferrer" href=https://github.com/wdoekes/asterisk-chan-dongle#chan_dongle-channel-driver-for-huawei-umts-cards target=_blank>README</a> file and try to get your hands on one of them. I bought an E1750 Huawei 3G dongle which you still find in stock in many online stores. If it’s unavailable in your local markets/ e-commerce sites, try searching it on eBay or AliExpress. I was able to get a second-hand one from eBay with SIM and voice support unlocked.<p>Once you have a dongle, insert your SIM card and plug it into the machine you have Asterisk installed. Make sure you have the <code>asterisk-chan-dongle</code> package installed.<p>To configure, we edit the <code>dongle.conf</code> file found in the configuration folder of Asterisk. The configuration folder is defined via the <code>astetcdir</code> option in the main <code>asterisk.conf</code> file and is usually <code>/etc/asterisk/</code>.<p>If there’s no <code>dongle.conf</code> file located in the configuration folder, create one. The default dongle.conf can be found <a rel="noopener nofollow noreferrer" href=https://github.com/wdoekes/asterisk-chan-dongle/blob/master/etc/dongle.conf target=_blank>here</a>.<p>Make a note of the <code>context</code> option in <code>dongle.conf</code>, the default value of <code>context</code> is <code>default</code> which we’ll be referencing later. You can change it to something more appropriate like <code>dongle-incoming</code> to make it easier to remember, which is what we’re doing in the below example.<p>The main configuration requirements are specifying the correct audio and data device ports of the dongle.<pre class=language-ini data-lang=ini style=color:#657b83;background-color:#fdf6e3><code class=language-ini data-lang=ini><span style=color:#268bd2>[dongle0]
</span><span style=color:#268bd2>context   </span><span style=color:#859900>=</span><span>   dongle</span><span style=color:#859900>-</span><span>incoming
</span><span>audio     =   /dev/ttyUSB1       </span><span style=color:#93a1a1>; tty port for audio connection;    no default value
</span><span>data      =   /dev/ttyUSB2       </span><span style=color:#93a1a1>; tty port for AT commands;         no default value
</span></code></pre><p>The exact value here will depend on your dongle and the distribution you’re running. You might need to install the <code>usb_modeswitch</code> package to switch the dongle from the initial CD-ROM/mass storage mode to the serial mode. You should then be able to start the Asterisk server and watch the logs for errors. Make sure there are no dongle-related errors.<p>Note: To enable logging you might need to edit <code>logger.conf</code> to increase the log level. (You can find the <code>messages</code> log file in the <code>astlogdir</code> folder) :<pre style=color:#657b83;background-color:#fdf6e3><code><span>console => notice,warning,error
</span><span>messages => notice,warning,error,debug
</span></code></pre><p>Check the status of your dongle and network registration via these two commands in the Asterisk console. (You can attach a console to a running Asterisk server via the command <code>asterisk -r</code>)<pre style=color:#657b83;background-color:#fdf6e3><code><span>dongle show devices
</span><span>dongle show device state dongle0
</span></code></pre><p>If the output shows the device state as “Free”, then you’re good to go.<h3 id=sms-forwarding-optional><a aria-label="Anchor link for: sms-forwarding-optional" class=zola-anchor href=#sms-forwarding-optional>🔗</a> SMS Forwarding (Optional)</h3><p>The easiest and simplest way to get acquainted with Asterisk and how to configure it is to set up SMS forwarding from our USB 3G dongle to an email ID.<p>We can do so by editing <code>extensions.conf</code>. The file is already well documented via comments (any line preceded by <code>;</code> is a comment and is ignored).<p>Append the following lines at the end of the file to set up SMS forwarding.<pre class=language-ini data-lang=ini style=color:#657b83;background-color:#fdf6e3><code class=language-ini data-lang=ini><span style=color:#268bd2>[dongle-incoming]
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> sms</span><span style=color:#859900>,</span><span style=color:#6c71c4>1</span><span style=color:#859900>,</span><span style=color:#b58900>Verbose</span><span>(Incoming </span><span style=color:#859900>SMS</span><span> from </span><span style=color:#2aa198>"${CALLERID(num)} ${BASE64_DECODE(${SMS_BASE64})}"</span><span>)
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> sms</span><span style=color:#859900>,</span><span>n</span><span style=color:#859900>,</span><span style=color:#b58900>System</span><span>(echo </span><span style=color:#2aa198>"To: user@example.com\nSubject: ${CALLERID(num)}\n\n${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)} - ${DONGLENAME} - ${CALLERID(num)}: " </span><span style=color:#859900>> /</span><span>tmp</span><span style=color:#859900>/</span><span>sms</span><span style=color:#859900>.</span><span>txt)
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> sms</span><span style=color:#859900>,</span><span>n</span><span style=color:#859900>,</span><span style=color:#b58900>System</span><span>(echo </span><span style=color:#2aa198>"${BASE64_DECODE(${SMS_BASE64})}" </span><span style=color:#859900>>> /</span><span>tmp</span><span style=color:#859900>/</span><span>sms</span><span style=color:#859900>.</span><span>txt)
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> sms</span><span style=color:#859900>,</span><span>n</span><span style=color:#859900>,</span><span style=color:#b58900>System</span><span>(msmtp </span><span style=color:#859900>-</span><span>t </span><span style=color:#859900>&lt; /</span><span>tmp</span><span style=color:#859900>/</span><span>sms</span><span style=color:#859900>.</span><span>txt)
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> sms</span><span style=color:#859900>,</span><span>n</span><span style=color:#859900>,</span><span style=color:#b58900>System</span><span>(rm </span><span style=color:#859900>-</span><span>f </span><span style=color:#859900>/</span><span>tmp</span><span style=color:#859900>/</span><span>sms</span><span style=color:#859900>.</span><span>txt)
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> sms</span><span style=color:#859900>,</span><span>n</span><span style=color:#859900>,</span><span style=color:#b58900>Hangup</span><span>()
</span><span>
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> ussd</span><span style=color:#859900>,</span><span style=color:#6c71c4>1</span><span style=color:#859900>,</span><span style=color:#b58900>Verbose</span><span>(Incoming </span><span style=color:#859900>USSD:</span><span> ${</span><span style=color:#b58900>BASE64_DECODE</span><span>(</span><span style=color:#859900>${USSD_BASE64}</span><span>)})
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> ussd</span><span style=color:#859900>,</span><span>n</span><span style=color:#859900>,</span><span style=color:#b58900>Hangup</span><span>()
</span></code></pre><p>Here <code>dongle-incoming</code> is the name of the context we defined in <code>dongle.conf</code>, and we define extensions within that context for receiving SMS by the way of <code>exten => sms</code>. You can read more about how <a rel="noopener nofollow noreferrer" href=https://wiki.asterisk.org/wiki/display/AST/Contexts%2C+Extensions%2C+and+Priorities target=_blank>Context, Extensions, and Priorities</a> work in Asterisk from their wiki.<p>Once we craft an email message we defer to a sendmail compatible SMTP client to send the email. This example uses <code>msmtp</code> here, you can instead use any other client and configure it accordingly.<p>The above extension configuration calls a few Asterisk built-in apps and functions that you might need to install separately. For OpenWRT install the following packages:<pre style=color:#657b83;background-color:#fdf6e3><code><span>opkg install asterisk-app-system asterisk-app-verbose asterisk-func-base64
</span></code></pre><p>If you just want SMS forwarding to your email and don’t care about PSTN voice calls then congratulations you should have SMS-to-email forwarding working at this point. If you want voice call functionality as well, continue reading.<h3 id=configuration><a aria-label="Anchor link for: configuration" class=zola-anchor href=#configuration>🔗</a> Configuration</h3><p>Once we have everything installed and running, it’s time to configure our Asterisk PBX server to do two things:<ol><li>Set up call extensions so that Asterisk knows how and where to route incoming and outgoing calls<li>Authenticate and interface with Twilio as a BYOC trunk</ol><p>While we don’t need to use Twilio or a VOIP service provider to act as a proxy for our PBX server, using one adds a level of security and reliability to our setup as we don’t need to whitelist dynamic IP addresses for communicating with a mobile softphone and Twilio’s global presence and edge locations enable much better performance and reliability than just directly talking to our home Asterisk server from across the globe.<p>The configuration shared here are just minimal examples that should work for most cases, you may have to tweak and adjust them to suit your setup and requirements.<p>There are a few files that we’ll need to edit mainly, <code>pjsip.conf</code>, <code>pjsip_wizard.conf</code> and <code>extensions.conf</code><p>The first thing that we need to do is set up a “transport” for Asterisk to use for SIP signaling in the <code>pjsip.conf</code> file:<pre class=language-ini data-lang=ini style=color:#657b83;background-color:#fdf6e3><code class=language-ini data-lang=ini><span style=color:#268bd2>[transport-udp]
</span><span style=color:#268bd2>type</span><span style=color:#859900>=</span><span>transport
</span><span style=color:#268bd2>protocol</span><span style=color:#859900>=</span><span>udp
</span><span style=color:#268bd2>bind</span><span style=color:#859900>=</span><span style=color:#cb4b16>0.0.0.0:5060
</span></code></pre><p>The next step is connecting our PBX to Twilio as a Trunk using their BYOC Trunk option. There is no direct guide provided by Twilio on how to set up a BYOC Trunk, especially with Asterisk, but the process is similar to setting up a Twilio Elastic SIP Trunk.<p>Twilio does, fortunately, provide a good enough guide for setting up an Elastic SIP trunk <a rel="noopener nofollow noreferrer" href=https://www.twilio.com/docs/sip-trunking/sample-configuration#asterisk target=_blank>here</a>, from where we can adapt the configuration shared in the “Asterisk Provisioning” section to work with the BYOC trunk.<p>For connecting with the Twilio network as a SIP trunk we need to have a user created with the corresponding credentials in addition to a SIP domain and a BYOC trunk domain. We can do so via the Twilio console dashboard, the exact steps for which are described in the “Twilio” section below.<blockquote><p>Note: The values highlighted in bold in the example configuration will be unique to your environment and needs to be replaced with appropriate values to work correctly.</blockquote><p><code>pjsip_wizard.conf:</code><pre style=color:#657b83;background-color:#fdf6e3>
<code><span>[user_defaults](!)
</span><span>type = wizard
</span><span>endpoint/context = from-twilio
</span><span>endpoint/allow = !all,ulaw,alaw
</span><span>endpoint/dtmf_mode = rfc4733
</span><span>endpoint/media_encryption = no
</span><span>endpoint/media_encryption_optimistic = no
</span><span>endpoint/trust_id_inbound = yes
</span><span>endpoint/send_pai = yes
</span><span>endpoint/language = en
</span><span>
</span><span>[<b>+919876543210</b>](user_defaults)
</span><span>aor/max_contacts = 5
</span><span>endpoint/callerid = <b>Alan Klein &lt;+919876543210></b>
</span><span>remote_hosts = <b>byoc.twilio-asteriskpbx.sip.singapore.twilio.com, byoc.twilio-asteriskpbx.sip.tokyo.twilio.com</b>
</span><span>
</span><span>[trunk_defaults](!)
</span><span>type = wizard
</span><span>endpoint/transport=transport-udp
</span><span>endpoint/allow = !all,ulaw,alaw
</span><span>endpoint/trust_id_inbound=no
</span><span>endpoint/dtmf_mode=rfc4733
</span><span>endpoint/allow_subscribe = no
</span><span>aor/qualify_frequency = 60
</span><span>
</span><span>[twilio-apac](trunk_defaults)
</span><span>sends_auth = yes
</span><span>sends_registrations = yes
</span><span>remote_hosts = <b>twilio-asteriskpbx.sip.singapore.twilio.com </b>
</span><span>outbound_auth/username = <b style=color:red>myasteriskpbx </b>
</span><span>outbound_auth/password = <b style=color:red>myasteriskpbxzx11%VzX </b>
</span><span>endpoint/context = from-twilio
</span><span>aor/qualify_frequency = 60
</span>
</code></pre><p>Next, we set up the extensions required to receive incoming calls from the PSTN network and forward them as a SIP call via the Twilio SIP domain to any registered softphones. And another extension for when we want to make a call from our softphone to then use the dongle for completing the call to a PSTN number.<p><code>extensions.conf</code>:<pre class=language-ini data-lang=ini style=color:#657b83;background-color:#fdf6e3><code class=language-ini data-lang=ini><span style=color:#268bd2>[dongle-incoming]
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=> +</span><span style=color:#6c71c4>919876543210</span><span style=color:#859900>,</span><span style=color:#6c71c4>1</span><span style=color:#859900>,</span><span style=color:#b58900>Dial</span><span>(</span><span style=color:#859900>PJSIP/</span><span>twilio</span><span style=color:#859900>-apac/sip:+</span><span style=color:#6c71c4>919876543210</span><span style=color:#859900>@twilio-</span><span>asteriskpbx</span><span style=color:#859900>.</span><span>sip</span><span style=color:#859900>.</span><span>twilio</span><span style=color:#859900>.</span><span>com</span><span style=color:#859900>, ,</span><span style=color:#b58900>b</span><span>(dongle</span><span style=color:#859900>-</span><span>incoming</span><span style=color:#859900>^</span><span>outbound</span><span style=color:#859900>^</span><span style=color:#6c71c4>1</span><span>))
</span><span>
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=></span><span> outbound</span><span style=color:#859900>,</span><span style=color:#6c71c4>1</span><span style=color:#859900>,</span><span style=color:#b58900>Set</span><span>(</span><span style=color:#b58900>JITTERBUFFER</span><span>(adaptive)</span><span style=color:#859900>=</span><span>default)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span style=color:#b58900>Set</span><span>(</span><span style=color:#b58900>AGC</span><span>(rx)</span><span style=color:#859900>=</span><span style=color:#6c71c4>4000</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span style=color:#b58900>Return</span><span>()
</span><span>
</span><span style=color:#268bd2>[from-twilio]
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=> _X.,</span><span style=color:#6c71c4>1</span><span style=color:#859900>,</span><span style=color:#b58900>Set</span><span>(</span><span style=color:#b58900>JITTERBUFFER</span><span>(adaptive)</span><span style=color:#859900>=</span><span style=color:#6c71c4>2000</span><span style=color:#859900>,</span><span style=color:#6c71c4>1600</span><span style=color:#859900>,</span><span style=color:#6c71c4>120</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span style=color:#b58900>Set</span><span>(</span><span style=color:#b58900>AGC</span><span>(rx)</span><span style=color:#859900>=</span><span style=color:#6c71c4>4000</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span style=color:#b58900>Dial</span><span>(Dongle</span><span style=color:#859900>/</span><span>dongle0</span><span style=color:#859900>/+</span><span style=color:#6c71c4>91</span><span style=color:#859900>${EXTEN}</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span>Hangup
</span><span>
</span><span style=color:#268bd2>exten </span><span style=color:#859900>=> _+</span><span style=color:#6c71c4>91X</span><span style=color:#859900>.,</span><span style=color:#6c71c4>1</span><span style=color:#859900>,</span><span style=color:#b58900>Set</span><span>(</span><span style=color:#b58900>JITTERBUFFER</span><span>(adaptive)</span><span style=color:#859900>=</span><span style=color:#6c71c4>2000</span><span style=color:#859900>,</span><span style=color:#6c71c4>1600</span><span style=color:#859900>,</span><span style=color:#6c71c4>120</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span style=color:#b58900>Set</span><span>(</span><span style=color:#b58900>AGC</span><span>(rx)</span><span style=color:#859900>=</span><span style=color:#6c71c4>4000</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span style=color:#b58900>Dial</span><span>(Dongle</span><span style=color:#859900>/</span><span>dongle0</span><span style=color:#859900>/${EXTEN}</span><span>)
</span><span style=color:#268bd2>same  </span><span style=color:#859900>=></span><span> n</span><span style=color:#859900>,</span><span>Hangup
</span></code></pre><blockquote><p>Note: Enabling Jitterbuffer and Automatic Gain Control (AGC) may require additional asterisk packages to be installed. On OpenWRT the package names are: <code>asterisk-func-jitterbuffer</code> and <code>asterisk-func-speex</code>.</blockquote><h3 id=nat-settings-optional><a aria-label="Anchor link for: nat-settings-optional" class=zola-anchor href=#nat-settings-optional>🔗</a> NAT settings (optional)</h3><p>If you’re running your Asterisk server on a private network and is behind Network Address Translation (NAT) then you’ll need to enable additional configuration options for Asterisk’s <code>res_pjsip</code> module to work reliably.<p>The most basic configuration required for networking behind a NAT is specifying the external media address in the transport configuration section of <code>pjsip.conf</code><pre class=language-diff data-lang=diff style=color:#657b83;background-color:#fdf6e3><code class=language-diff data-lang=diff><span>[transport-udp]
</span><span>type=transport
</span><span>protocol=udp
</span><span>bind=0.0.0.0:5060
</span><span style=color:#859900>+; NAT settings
</span><span style=color:#859900>+local_net                  = 127.0.0.1/24
</span><span style=color:#859900>+local_net                  = 192.168.1.0/24
</span><span style=color:#859900>+external_media_address     = home.example.com ; or a public static IP
</span><span style=color:#859900>+external_signaling_address = home.example.com ; or a public static IP
</span><span style=color:#859900>+allow_reload=no
</span></code></pre><p>You can find more details on how to configure Asterisk behind a NAT from their <a rel="noopener nofollow noreferrer" href=https://wiki.asterisk.org/wiki/display/AST/Configuring+res_pjsip+to+work+through+NAT target=_blank>wiki</a><h2 id=twilio><a aria-label="Anchor link for: twilio" class=zola-anchor href=#twilio>🔗</a> Twilio</h2><p>The last step in our setup is to configure Twilio SIP domain and BYOC trunk from the Twilio console. Twilio has a nice tutorial for setting up a <a rel="noopener nofollow noreferrer" href=https://www.twilio.com/blog/registering-sip-phone-twilio-inbound-outbound target=_blank>SIP phone</a> for incoming/outgoing calls directly from Twilio’s SIP domain.<p>We adapt from the tutorial for setting up two SIP domains:<p>The first SIP domain will be set up similar to the one in the tutorial but with a different webhook URL for the “A Call Comes In” configuration option. The Webhook URL can be the URL of a Twilio Function or self-hosted server of the following Nodejs script:<pre class=language-javascript data-lang=javascript style=color:#657b83;background-color:#fdf6e3><code class=language-javascript data-lang=javascript><span style=color:#93a1a1>/* URL Parameters
</span><span style=color:#93a1a1>URL parameters: defaultCountry=[international country code - ISO alpha2]
</span><span style=color:#93a1a1>Feel free to remove any console.log statements.
</span><span style=color:#93a1a1>*/
</span><span style=color:#93a1a1>// Require `PhoneNumberFormat`.
</span><span style=color:#268bd2>const PNF </span><span>= </span><span style=color:#859900>require</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>google-libphonenumber</span><span style=color:#839496>'</span><span>).</span><span style=color:#268bd2>PhoneNumberFormat</span><span>;
</span><span style=color:#268bd2>const url </span><span>= </span><span style=color:#859900>require</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>url</span><span style=color:#839496>'</span><span>);
</span><span style=color:#93a1a1>// Get an instance of `PhoneNumberUtil`.
</span><span style=color:#268bd2>const phoneUtil </span><span>= </span><span style=color:#859900>require</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>google-libphonenumber</span><span style=color:#839496>'</span><span>).</span><span style=color:#268bd2>PhoneNumberUtil</span><span>.</span><span style=color:#b58900>getInstance</span><span>();
</span><span>
</span><span style=color:#859900>exports</span><span>.</span><span style=color:#b58900>handler </span><span>= </span><span style=color:#268bd2>function</span><span>(</span><span style=color:#268bd2>context</span><span>, </span><span style=color:#268bd2>event</span><span>, </span><span style=color:#268bd2>callback</span><span>) {
</span><span>    </span><span style=color:#268bd2>const client </span><span>= </span><span style=color:#268bd2>context</span><span>.</span><span style=color:#b58900>getTwilioClient</span><span>();
</span><span>    </span><span style=color:#268bd2>let twiml </span><span>= </span><span style=color:#859900>new </span><span style=color:#b58900>Twilio</span><span>.</span><span style=color:#b58900>twiml</span><span>.</span><span style=color:#b58900>VoiceResponse</span><span>();
</span><span>    </span><span style=color:#268bd2>const </span><span>{ </span><span style=color:#268bd2>From</span><span>: </span><span style=color:#268bd2>fromNumber</span><span>, </span><span style=color:#268bd2>To</span><span>: </span><span style=color:#268bd2>toNumber</span><span>, </span><span style=color:#268bd2>SipDomainSid</span><span>: </span><span style=color:#268bd2>sipDomainSid </span><span>} = </span><span style=color:#859900>event</span><span>;
</span><span>    </span><span style=color:#268bd2>let mergedAggregatedE164CredentialUsernames </span><span>= </span><span style=color:#268bd2>[]</span><span>;
</span><span>    </span><span style=color:#268bd2>let regExNumericSipUri </span><span>= </span><span style=color:#839496>/</span><span style=color:#859900>^</span><span style=color:#2aa198>sip:((</span><span style=color:#dc322f>\+</span><span style=color:#2aa198>)</span><span style=color:#859900>?</span><span style=color:#cb4b16>[0-9]</span><span style=color:#859900>+</span><span style=color:#2aa198>)@(</span><span style=color:#cb4b16>.</span><span style=color:#859900>*</span><span style=color:#2aa198>)</span><span style=color:#839496>/</span><span>;
</span><span>    </span><span style=color:#268bd2>let regAlphaSipUri </span><span>= </span><span style=color:#839496>/</span><span style=color:#859900>^</span><span style=color:#2aa198>sip:((</span><span style=color:#cb4b16>[a-zA-Z][\w]</span><span style=color:#859900>+</span><span style=color:#2aa198>)@(</span><span style=color:#cb4b16>.</span><span style=color:#859900>*</span><span style=color:#2aa198>))</span><span style=color:#839496>/</span><span>;
</span><span>    </span><span style=color:#93a1a1>// Change the defaultCallerId to a phone number in your account
</span><span>    </span><span style=color:#93a1a1>// and BYOC_SID to your byoc trunks SID.
</span><span>    </span><span style=color:#268bd2>const BYOC_SID </span><span>= </span><span style=color:#839496>'</span><span style=color:#2aa198>BY6f6abd4dadcf7d0de2ec4f828a167bac</span><span style=color:#839496>'</span><span>;
</span><span>    </span><span style=color:#268bd2>const DEFAULT_CALLER_ID </span><span>= </span><span style=color:#839496>'</span><span style=color:#2aa198>+919876543210</span><span style=color:#839496>'</span><span>;  </span><span style=color:#93a1a1>// Also our BYOC number
</span><span>    </span><span style=color:#268bd2>let defaultCountry </span><span>= </span><span style=color:#859900>event</span><span>.</span><span style=color:#268bd2>defaultCountry </span><span style=color:#859900>|| </span><span style=color:#839496>'</span><span style=color:#2aa198>US</span><span style=color:#839496>'</span><span>;
</span><span>    </span><span style=color:#268bd2>let fromSipCallerId </span><span>= (</span><span style=color:#268bd2>fromNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)
</span><span>    </span><span style=color:#859900>? </span><span style=color:#268bd2>fromNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)</span><span style=color:#268bd2>[</span><span style=color:#6c71c4>1</span><span style=color:#268bd2>] </span><span style=color:#859900>:
</span><span>    </span><span style=color:#268bd2>fromNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regAlphaSipUri</span><span>)</span><span style=color:#268bd2>[</span><span style=color:#6c71c4>2</span><span style=color:#268bd2>]</span><span>);
</span><span>    </span><span style=color:#859900>if </span><span>(</span><span style=color:#859900>!</span><span style=color:#268bd2>toNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)) {
</span><span>        </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>Dialing an alphanumeric SIP User</span><span style=color:#839496>'</span><span>);
</span><span>        </span><span style=color:#268bd2>twiml</span><span>.</span><span style=color:#b58900>dial</span><span>({callerId: </span><span style=color:#268bd2>fromSipCallerId</span><span>, answerOnBridge: </span><span style=color:#b58900>true</span><span>})
</span><span>        .</span><span style=color:#b58900>sip</span><span>(</span><span style=color:#268bd2>toNumber</span><span>);
</span><span>        </span><span style=color:#b58900>callback</span><span>(</span><span style=color:#b58900>null</span><span>, </span><span style=color:#268bd2>twiml</span><span>);
</span><span>    }
</span><span>    </span><span style=color:#268bd2>let normalizedFrom </span><span>= (</span><span style=color:#268bd2>fromNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)
</span><span>    </span><span style=color:#859900>? </span><span style=color:#268bd2>fromNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)</span><span style=color:#268bd2>[</span><span style=color:#6c71c4>1</span><span style=color:#268bd2>] </span><span style=color:#859900>: </span><span style=color:#268bd2>DEFAULT_CALLER_ID</span><span>);
</span><span>    </span><span style=color:#268bd2>let normalizedTo </span><span>= </span><span style=color:#268bd2>toNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)</span><span style=color:#268bd2>[</span><span style=color:#6c71c4>1</span><span style=color:#268bd2>]</span><span>;
</span><span>    </span><span style=color:#268bd2>let sipDomain </span><span>=  </span><span style=color:#268bd2>toNumber</span><span>.</span><span style=color:#859900>match</span><span>(</span><span style=color:#268bd2>regExNumericSipUri</span><span>)</span><span style=color:#268bd2>[</span><span style=color:#6c71c4>3</span><span style=color:#268bd2>]</span><span>;
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>Original From Number: ${</span><span style=color:#268bd2>fromNumber</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>Original To Number: ${</span><span style=color:#268bd2>toNumber</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>Normalized PSTN From Number: ${</span><span style=color:#268bd2>normalizedFrom</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>Normalized To Number: ${</span><span style=color:#268bd2>normalizedTo</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>SIP CallerID: ${</span><span style=color:#268bd2>fromSipCallerId</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>    </span><span style=color:#93a1a1>// Parse number with US country code and keep raw input.
</span><span>    </span><span style=color:#268bd2>const rawFromNumber </span><span>= </span><span style=color:#268bd2>phoneUtil</span><span>.</span><span style=color:#b58900>parseAndKeepRawInput</span><span>(</span><span style=color:#268bd2>normalizedFrom</span><span>, </span><span style=color:#268bd2>defaultCountry</span><span>);
</span><span>    </span><span style=color:#268bd2>const rawtoNumber </span><span>= </span><span style=color:#268bd2>phoneUtil</span><span>.</span><span style=color:#b58900>parseAndKeepRawInput</span><span>(</span><span style=color:#268bd2>normalizedTo</span><span>, </span><span style=color:#268bd2>defaultCountry</span><span>);
</span><span>    </span><span style=color:#93a1a1>// Format number in E.164 format
</span><span>    </span><span style=color:#268bd2>fromE164Normalized </span><span>= </span><span style=color:#268bd2>phoneUtil</span><span>.</span><span style=color:#b58900>format</span><span>(</span><span style=color:#268bd2>rawFromNumber</span><span>, </span><span style=color:#268bd2>PNF</span><span>.</span><span style=color:#268bd2>E164</span><span>);
</span><span>    </span><span style=color:#268bd2>toE164Normalized </span><span>= </span><span style=color:#268bd2>phoneUtil</span><span>.</span><span style=color:#b58900>format</span><span>(</span><span style=color:#268bd2>rawtoNumber</span><span>, </span><span style=color:#268bd2>PNF</span><span>.</span><span style=color:#268bd2>E164</span><span>);
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>E.164 From Number: ${</span><span style=color:#268bd2>fromE164Normalized</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>    </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>E.164 To Number: ${</span><span style=color:#268bd2>toE164Normalized</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>
</span><span>    </span><span style=color:#268bd2>function </span><span style=color:#b58900>enumerateCredentialLists</span><span>(</span><span style=color:#268bd2>sipDomainSid</span><span>) {
</span><span>        </span><span style=color:#859900>return </span><span style=color:#268bd2>client</span><span>.</span><span style=color:#268bd2>sip</span><span>.</span><span style=color:#b58900>domains</span><span>(</span><span style=color:#268bd2>sipDomainSid</span><span>)
</span><span>            .</span><span style=color:#268bd2>auth
</span><span>            .</span><span style=color:#268bd2>registrations
</span><span>            .</span><span style=color:#268bd2>credentialListMappings
</span><span>            .</span><span style=color:#b58900>list</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#268bd2>function </span><span style=color:#b58900>getSIPCredentialListUsernames</span><span>(</span><span style=color:#268bd2>credList</span><span>) {
</span><span>        </span><span style=color:#859900>return </span><span style=color:#268bd2>client</span><span>.</span><span style=color:#268bd2>sip</span><span>.</span><span style=color:#b58900>credentialLists</span><span>(</span><span style=color:#268bd2>credList</span><span>)
</span><span>            .</span><span style=color:#268bd2>credentials
</span><span>            .</span><span style=color:#b58900>list</span><span>();
</span><span>    }
</span><span>    </span><span style=color:#b58900>enumerateCredentialLists</span><span>(</span><span style=color:#268bd2>sipDomainSid</span><span>).</span><span style=color:#859900>then</span><span>(</span><span style=color:#268bd2>credentialLists => </span><span>{
</span><span>        </span><span style=color:#859900>Promise</span><span>.</span><span style=color:#859900>all</span><span>(</span><span style=color:#268bd2>credentialLists</span><span>.</span><span style=color:#b58900>map</span><span>(</span><span style=color:#268bd2>credList => </span><span>{
</span><span>            </span><span style=color:#859900>return </span><span style=color:#b58900>getSIPCredentialListUsernames</span><span>(</span><span style=color:#268bd2>credList</span><span>.</span><span style=color:#268bd2>sid</span><span>);
</span><span>        }))
</span><span>        .</span><span style=color:#859900>then</span><span>(</span><span style=color:#268bd2>results => </span><span>{
</span><span>            </span><span style=color:#268bd2>results</span><span>.</span><span style=color:#859900>forEach</span><span>(</span><span style=color:#268bd2>credentials => </span><span>{
</span><span>                </span><span style=color:#93a1a1>// Merge together all SIP Domain associated registration
</span><span>                </span><span style=color:#93a1a1>// credential list usernames prefixed by + into one array
</span><span>                </span><span style=color:#268bd2>mergedAggregatedE164CredentialUsernames</span><span>.</span><span style=color:#268bd2>push
</span><span>                .</span><span style=color:#859900>apply</span><span>(</span><span style=color:#268bd2>mergedAggregatedE164CredentialUsernames</span><span>,
</span><span>                </span><span style=color:#268bd2>credentials</span><span>.</span><span style=color:#b58900>filter</span><span>(</span><span style=color:#268bd2>record => record[</span><span style=color:#839496>"</span><span style=color:#2aa198>username</span><span style=color:#839496>"</span><span style=color:#268bd2>]</span><span>.</span><span style=color:#b58900>startsWith</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>+</span><span style=color:#839496>'</span><span>))
</span><span>                .</span><span style=color:#b58900>map</span><span>(</span><span style=color:#268bd2>record => record</span><span>.</span><span style=color:#268bd2>username</span><span>));
</span><span>            });
</span><span>            </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#268bd2>mergedAggregatedE164CredentialUsernames</span><span>);
</span><span>
</span><span>            </span><span style=color:#859900>if </span><span>(</span><span style=color:#268bd2>mergedAggregatedE164CredentialUsernames</span><span>.</span><span style=color:#b58900>includes</span><span>(</span><span style=color:#268bd2>toE164Normalized</span><span>)) {
</span><span>                </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>Dialing another E.164 SIP User</span><span style=color:#839496>'</span><span>);
</span><span>                </span><span style=color:#268bd2>twiml</span><span>.</span><span style=color:#b58900>dial</span><span>({
</span><span>                    callerId: </span><span style=color:#268bd2>fromSipCallerId</span><span>,
</span><span>                    answerOnBridge: </span><span style=color:#b58900>true
</span><span>                })
</span><span>                .</span><span style=color:#b58900>sip</span><span>(</span><span style=color:#839496>`</span><span style=color:#2aa198>sip:${</span><span style=color:#268bd2>toE164Normalized</span><span style=color:#2aa198>}@${</span><span style=color:#268bd2>sipDomain</span><span style=color:#2aa198>}</span><span style=color:#839496>`</span><span>);
</span><span>            } </span><span style=color:#859900>else if </span><span>(</span><span style=color:#268bd2>fromE164Normalized </span><span>=== </span><span style=color:#268bd2>DEFAULT_CALLER_ID</span><span>) {
</span><span>               </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>Dialing a PSTN Number via BYOC</span><span style=color:#839496>'</span><span>);
</span><span>               </span><span style=color:#268bd2>twiml</span><span>.</span><span style=color:#b58900>dial</span><span>({callerId: </span><span style=color:#268bd2>fromE164Normalized</span><span>, answerOnBridge: </span><span style=color:#b58900>true</span><span>})
</span><span>                 .</span><span style=color:#b58900>number</span><span>({byoc: </span><span style=color:#268bd2>BYOC_SID</span><span>}, </span><span style=color:#268bd2>toE164Normalized</span><span>);
</span><span>            } </span><span style=color:#859900>else </span><span>{
</span><span>               </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#839496>'</span><span style=color:#2aa198>Dialing a PSTN Number</span><span style=color:#839496>'</span><span>);
</span><span>               </span><span style=color:#268bd2>twiml</span><span>.</span><span style=color:#b58900>dial</span><span>(
</span><span>                   {callerId: </span><span style=color:#268bd2>fromE164Normalized</span><span>, answerOnBridge: </span><span style=color:#b58900>true</span><span>},
</span><span>                   </span><span style=color:#268bd2>toE164Normalized
</span><span>                );
</span><span>            }
</span><span>                </span><span style=color:#b58900>callback</span><span>(</span><span style=color:#b58900>null</span><span>, </span><span style=color:#268bd2>twiml</span><span>);
</span><span>            }).</span><span style=color:#859900>catch</span><span>(</span><span style=color:#268bd2>err => </span><span>{
</span><span>                </span><span style=color:#859900>console</span><span>.</span><span style=color:#859900>log</span><span>(</span><span style=color:#268bd2>err</span><span>);
</span><span>                </span><span style=color:#b58900>callback</span><span>(</span><span style=color:#268bd2>err</span><span>);
</span><span>            });
</span><span>    });
</span><span>};
</span></code></pre><p>Change the <code>DEFAULT_CALLER_ID</code> variable value to your SIM card number and <code>BYOC_SID</code> value to the SID you get after creating a BYOC trunk SIP domain described below.<p>The above script either calls a PSTN number via our BYOC trunk when calling from our BYOC number or via a Twilio number when calling from a username formatted as an E.164 Twilio number or makes a SIP call when the To number is a username in our credentials list.<p>The second SIP domain will have the selection “BYOC trunk” as the configuration under the “Call Control Configuration” section. The details for setting up a Twilio BYOC trunk can be found in Twilio’s <a rel="noopener nofollow noreferrer" href=https://www.twilio.com/docs/voice/bring-your-own-carrier-byoc target=_blank>BYOC trunk</a> documentation.<p>You can also enable voicemail on incoming calls to your number by adding an <code>action</code> field to the <code>&lt;Dial></code> verb followed by the <code>&lt;Sip></code> noun<pre class=language-diff data-lang=diff style=color:#657b83;background-color:#fdf6e3><code class=language-diff data-lang=diff><span style=color:#268bd2>@@ -77,6 +77,7 @@ </span><span style=color:#cb4b16>exports.handler = function(context, event, callback) {
</span><span>            if (mergedAggregatedE164CredentialUsernames.includes(toE164Normalized)) {
</span><span>                console.log('Dialing another E.164 SIP User');
</span><span>                twiml.dial({
</span><span style=color:#859900>+                   action: url.resolve(context.PATH, 'voicemail'),
</span><span>                    callerId: fromSipCallerId,
</span><span>                    record: "record-from-answer",
</span><span>                    answerOnBridge: true
</span><span>
</span></code></pre><p>You then need to have a <code>/voicemail</code> webhook available which then records a message. Here’s an example: <a rel="noopener nofollow noreferrer" href=https://gist.github.com/shalzz/3046edd4d2dca123875ac84853f1cbc1 target=_blank>https://gist.github.com/shalzz/3046edd4d2dca123875ac84853f1cbc1</a><p>Twilio provides a generous amount of trial credits, letting you test and correct your setup before moving onto a paid plan which is when you start paying for usage. You can use my <a rel="noopener nofollow noreferrer" href=https://www.twilio.com/referral/KrXNxn target=_blank>Twilio referral link</a> to get $10 in credit when you upgrade.<h2 id=softphone><a aria-label="Anchor link for: softphone" class=zola-anchor href=#softphone>🔗</a> Softphone</h2><p>The last remaining piece of the puzzle is a softphone app through which you’ll receive and make calls. There are a few good softphone apps that work across platforms:<ul><li><a rel="noopener nofollow noreferrer" href=https://linphone.org/ target=_blank>Linephone</a><li><a rel="noopener nofollow noreferrer" href=https://www.acrobits.net/sip-client-ios-android/ target=_blank>Acrobits Softphone</a><li><a rel="noopener nofollow noreferrer" href=https://www.counterpath.com/bria-solo/ target=_blank>Bria</a></ul><h2 id=further-improvements><a aria-label="Anchor link for: further-improvements" class=zola-anchor href=#further-improvements>🔗</a> Further Improvements</h2><ul><li><a rel="noopener nofollow noreferrer" href=https://www.twilio.com/docs/voice/api/secure-media target=_blank>SRTP Media transport</a><li><a rel="noopener nofollow noreferrer" href=https://www.twilio.com/docs/global-infrastructure/understanding-twilio-regions target=_blank>Twilio region</a></ul></article><div>Liked this article? Share this with others</div><p>Got any questions or comments? Drop me a message on <a href=https://twitter.com/shalzzj rel=nofollow>Twitter @shalzzj</a><div>Sign up for my newsletter to be the first to know about a new post <div id=mc_embed_signup><form action="https://shaleenjain.us1.list-manage.com/subscribe/post?u=1eaa5ecf0b59e6a364a3c9c1a&id=dbd95a64e5" class=validate id=mc-embedded-subscribe-form method=post name=mc-embedded-subscribe-form novalidate target=_blank><div id=mc_embed_signup_scroll><div class=mc-field-group><input class="required email plausible-event-name=EmailInput" placeholder="Email Address" id=mce-EMAIL name=EMAIL type=email></div><div aria-hidden=true style=position:absolute;left:-5000px><input name=b_1eaa5ecf0b59e6a364a3c9c1a_dbd95a64e5 tabindex=-1></div><div class=mce-submit><input class="button plausible-event-name=Subscribe" id=mc-embedded-subscribe name=subscribe type=submit value=Subscribe></div></div><div id=mce-responses><div class=response id=mce-error-response></div><div class=response id=mce-success-response></div></div></form></div><script defer src=//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js></script><script>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script></div></main><footer class=footer><p><small> This work is licensed under the <a href=http://creativecommons.org/licenses/by-sa/4.0/ rel=license> CC BY-SA 4.0</a> license. <br> <a href=/atom.xml>RSS Feed</a> — <a href=/donate>Donate</a> </small></footer><script data-domain=shaleenjain.com defer src=https://plausible.8bitlabs.dev/js/script.outbound-links.tagged-events.js></script>